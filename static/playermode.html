<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Individual Time Availability</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#1E40AF", // Deep blue
                        secondary: "#FACC15", // Volleyball yellow
                        "background-light": "#F8FAFC",
                        "background-dark": "#0F172A",
                        "card-light": "#FFFFFF",
                        "card-dark": "#1E293B",
                    },
                    fontFamily: {
                        display: ["Inter", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "12px",
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .time-slot {
            height: 44px;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
    <div class="h-12 w-full bg-primary"></div>
    <header class="bg-primary px-4 py-3 flex items-center justify-between shadow-md sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <button class="text-white">
                <span class="material-icons">arrow_back_ios</span>
            </button>
            <h1 id="game-header" class="text-white font-bold text-lg">Weekend Play</h1>
        </div>
        <div id="date-badge" class="bg-secondary text-primary px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">
            Loading...
        </div>
    </header>
    <main class="flex-1 overflow-y-auto pb-24">
        <div class="p-4 bg-white dark:bg-card-dark border-b border-slate-200 dark:border-slate-800">
            <h2 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase mb-3">Availability Legend</h2>
            <div class="flex flex-wrap gap-4 items-center text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-emerald-500"></div>
                    <span>Available</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-rose-400"></div>
                    <span>Unavailable</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded bg-slate-300 dark:bg-slate-600"></div>
                    <span>Group Heatmap</span>
                </div>
            </div>
            <p class="mt-3 text-xs text-slate-400 italic">Tap blocks to toggle. Changes save automatically.</p>
        </div>
        <div class="flex px-4 pt-4 gap-2">
            <button id="sat-tab"
                class="flex-1 py-2 rounded-t-lg bg-white dark:bg-card-dark border-b-2 border-primary font-bold text-primary">Saturday</button>
            <button id="sun-tab" class="flex-1 py-2 rounded-t-lg bg-slate-100 dark:bg-slate-800 text-slate-400 font-medium">Sunday</button>
        </div>
        <div class="px-4">
            <div
                class="bg-white dark:bg-card-dark rounded-b-xl shadow-sm border-x border-b border-slate-200 dark:border-slate-800 overflow-hidden">
                <div
                    class="grid grid-cols-12 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                    <div class="col-span-2 p-2"></div>
                    <div
                        class="col-span-5 p-2 text-center text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">
                        My Status</div>
                    <div
                        class="col-span-5 p-2 text-center text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">
                        Group</div>
                </div>
                <div id="time-slots-container" class="divide-y divide-slate-100 dark:divide-slate-800">
                    <!-- Time slots will be rendered dynamically -->
                </div>
            </div>
        </div>
        <div class="mt-6 px-4">
            <div
                class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800 flex items-center gap-4">
                <div class="bg-primary text-white p-2 rounded-lg">
                    <span class="material-icons">groups</span>
                </div>
                <div>
                    <h3 class="text-sm font-bold text-primary dark:text-blue-300">Top Suggested Time</h3>
                    <p id="suggested-time" class="text-xs text-blue-700 dark:text-blue-400">Mark your availability to see suggestions</p>
                </div>
            </div>
        </div>
    </main>
    <nav
        class="fixed bottom-0 left-0 right-0 bg-white dark:bg-card-dark border-t border-slate-200 dark:border-slate-800 pb-safe shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50">
        <div class="flex justify-around items-center py-2">
            <button class="flex flex-col items-center gap-1 text-slate-400">
                <span class="material-icons">home</span>
                <span class="text-[10px]">Home</span>
            </button>
            <button class="flex flex-col items-center gap-1 text-primary">
                <span class="material-icons">calendar_month</span>
                <span class="text-[10px]">Availability</span>
            </button>
            <div class="relative -mt-8">
                <button
                    class="bg-secondary text-primary w-14 h-14 rounded-full shadow-lg flex items-center justify-center border-4 border-white dark:border-background-dark">
                    <span class="material-icons text-3xl">sports_volleyball</span>
                </button>
            </div>
            <button class="flex flex-col items-center gap-1 text-slate-400">
                <span class="material-icons">chat</span>
                <span class="text-[10px]">Chat</span>
            </button>
            <button class="flex flex-col items-center gap-1 text-slate-400">
                <span class="material-icons">person</span>
                <span class="text-[10px]">Profile</span>
            </button>
        </div>
    </nav>
    <script>
        const API_BASE = '/api';
        let currentGame = null;
        let currentPlayer = null;
        let currentDay = 'saturday';
        let timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00']; // default fallback
        let myAvailability = {};

        function showError(message) {
            // Remove existing error toasts
            document.querySelectorAll('.error-toast').forEach(el => el.remove());

            const toast = document.createElement('div');
            toast.className = 'error-toast fixed bottom-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 4000);
        }

        async function apiCall(url, options = {}) {
            try {
                const res = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'Request failed');
                }

                return data;
            } catch (err) {
                showError(err.message);
                throw err;
            }
        }

        async function loadConfig() {
            // Fetch config if not cached
            if (!window.appConfig) {
                try {
                    const res = await fetch(`${API_BASE}/config`);
                    window.appConfig = await res.json();
                    timeSlots = window.appConfig.time_slots || timeSlots;
                } catch (err) {
                    console.error('Failed to load config:', err);
                    // Keep default timeSlots as fallback
                }
            }
        }

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');

            if (!gameId) {
                alert('No game specified. Please use a valid invite link.');
                return;
            }

            await loadConfig();
            await loadGame(gameId);
            checkExistingPlayer();
            setupEventListeners();
            renderTimeSlots();
            await loadHeatmap();
        }

        async function loadGame(gameId) {
            try {
                const res = await fetch(`${API_BASE}/games/${gameId}`);
                if (!res.ok) throw new Error('Game not found');
                currentGame = await res.json();
                displayGame();
            } catch (e) {
                console.error('Error loading game:', e);
                alert('Game not found. Please check your invite link.');
            }
        }

        function displayGame() {
            if (!currentGame) return;
            const gameDate = new Date(currentGame.game_date);
            document.getElementById('game-header').textContent = currentGame.title || 'Weekend Play';

            // Set date badge
            const dateStr = gameDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            document.getElementById('date-badge').textContent = dateStr;

            // Update tab labels
            const satDate = new Date(currentGame.game_date);
            const sunDate = new Date(currentGame.game_date);
            if (satDate.getDay() === 0) {
                satDate.setDate(satDate.getDate() - 1);
            } else {
                sunDate.setDate(sunDate.getDate() + 1);
            }
            document.getElementById('sat-tab').textContent = satDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('sun-tab').textContent = sunDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }

        function checkExistingPlayer() {
            const savedPlayerId = localStorage.getItem(`player_${currentGame?.id}`);
            const savedPlayerName = localStorage.getItem(`playerName_${currentGame?.id}`);
            if (savedPlayerId && savedPlayerName) {
                currentPlayer = { id: parseInt(savedPlayerId), name: savedPlayerName };
            }
        }

        async function registerPlayer(name) {
            try {
                const res = await fetch(`${API_BASE}/games/${currentGame.id}/players`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                currentPlayer = await res.json();
                localStorage.setItem(`player_${currentGame.id}`, currentPlayer.id);
                localStorage.setItem(`playerName_${currentGame.id}`, currentPlayer.name);
                return true;
            } catch (e) {
                console.error('Error registering player:', e);
                return false;
            }
        }

        function renderTimeSlots() {
            const container = document.getElementById('time-slots-container');
            container.innerHTML = '';

            timeSlots.forEach((slot, idx) => {
                const hour = parseInt(slot.split(':')[0]);
                const displayTime = hour > 12 ? `${hour - 12} PM` : (hour === 12 ? '12 PM' : `${hour} AM`);

                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 items-center' + (idx < timeSlots.length - 1 ? ' border-b border-slate-100 dark:border-slate-800' : '');
                row.innerHTML = `
                    <div class="col-span-2 text-[10px] font-bold text-right pr-2 text-slate-400">${displayTime}</div>
                    <div class="col-span-5 p-1">
                        <button data-slot="${slot}" class="slot-btn w-full h-10 rounded-md bg-slate-200 dark:bg-slate-700 transition-colors active:scale-95 flex items-center justify-center">
                            <span class="material-icons text-slate-400 text-sm">help_outline</span>
                        </button>
                    </div>
                    <div class="col-span-5 p-1">
                        <div id="heatmap-${slot}" class="w-full h-10 rounded-md bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                            <span class="text-[10px] font-bold text-slate-400">0/0</span>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });

            // Add click handlers
            document.querySelectorAll('.slot-btn').forEach(btn => {
                btn.addEventListener('click', () => toggleSlot(btn));
            });
        }

        function toggleSlot(btn) {
            if (!currentPlayer) {
                showNamePrompt(() => toggleSlot(btn));
                return;
            }

            const slot = btn.dataset.slot;
            const key = `${currentDay}_${slot}`;
            const icon = btn.querySelector('.material-icons');

            if (myAvailability[key] === 'available') {
                myAvailability[key] = 'unavailable';
                btn.className = 'slot-btn w-full h-10 rounded-md bg-rose-400 transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'close';
                icon.className = 'material-icons text-white text-sm';
            } else if (myAvailability[key] === 'unavailable') {
                delete myAvailability[key];
                btn.className = 'slot-btn w-full h-10 rounded-md bg-slate-200 dark:bg-slate-700 transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'help_outline';
                icon.className = 'material-icons text-slate-400 text-sm';
            } else {
                myAvailability[key] = 'available';
                btn.className = 'slot-btn w-full h-10 rounded-md bg-emerald-500 transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'check';
                icon.className = 'material-icons text-white text-sm';
            }

            // Auto-save
            saveAvailability();
        }

        function showNamePrompt(callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-4 text-center">What's your name?</h3>
                    <input id="player-name-input" type="text" placeholder="Enter your name"
                        class="w-full border border-slate-200 dark:border-slate-700 rounded-xl p-3 mb-4 bg-white dark:bg-slate-800" />
                    <button id="confirm-name-btn"
                        class="w-full bg-primary text-white py-3 rounded-xl font-bold">
                        Confirm
                    </button>
                </div>
            `;
            document.body.appendChild(modal);

            const input = document.getElementById('player-name-input');
            const btn = document.getElementById('confirm-name-btn');

            btn.addEventListener('click', async () => {
                const name = input.value.trim();
                if (!name) {
                    alert('Please enter your name');
                    return;
                }
                if (await registerPlayer(name)) {
                    modal.remove();
                    if (callback) callback();
                }
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            input.focus();
        }

        async function loadHeatmap() {
            if (!currentGame) return;
            try {
                const res = await fetch(`${API_BASE}/games/${currentGame.id}/heatmap`);
                const heatmapData = await res.json();

                const dayData = heatmapData.find(d => d.day === currentDay);
                if (!dayData) return;

                dayData.slots.forEach(slot => {
                    const el = document.getElementById(`heatmap-${slot.time_slot}`);
                    if (el) {
                        const ratio = slot.total_count > 0 ? slot.available_count / slot.total_count : 0;
                        let bgClass = 'bg-slate-100 dark:bg-slate-800';
                        let textClass = 'text-slate-400';

                        if (ratio >= 0.8) {
                            bgClass = 'bg-slate-500 dark:bg-slate-400';
                            textClass = 'text-white dark:text-slate-900';
                        } else if (ratio >= 0.6) {
                            bgClass = 'bg-slate-400 dark:bg-slate-500';
                            textClass = 'text-white';
                        } else if (ratio >= 0.4) {
                            bgClass = 'bg-slate-300 dark:bg-slate-600';
                            textClass = 'text-slate-600 dark:text-slate-300';
                        } else if (ratio > 0) {
                            bgClass = 'bg-slate-200 dark:bg-slate-700';
                            textClass = 'text-slate-500';
                        }

                        el.className = `w-full h-10 rounded-md ${bgClass} flex items-center justify-center`;
                        el.innerHTML = `<span class="text-[10px] font-bold ${textClass}">${slot.available_count}/${slot.total_count}</span>`;
                    }
                });

                // Find suggested time
                const bestSlot = dayData.slots.reduce((best, slot) =>
                    slot.available_count > (best?.available_count || 0) ? slot : best, null);

                if (bestSlot && bestSlot.available_count > 0) {
                    const hour = parseInt(bestSlot.time_slot.split(':')[0]);
                    const displayTime = hour > 12 ? `${hour - 12}:00 PM` : (hour === 12 ? '12:00 PM' : `${hour}:00 AM`);
                    document.getElementById('suggested-time').textContent =
                        `${currentDay.charAt(0).toUpperCase() + currentDay.slice(1)} @ ${displayTime} (${bestSlot.available_count} players)`;
                }
            } catch (e) {
                console.error('Error loading heatmap:', e);
            }
        }

        async function saveAvailability() {
            if (!currentPlayer || !currentGame) return;

            const slots = {};
            timeSlots.forEach(slot => {
                const key = `${currentDay}_${slot}`;
                if (myAvailability[key]) {
                    slots[slot] = myAvailability[key];
                }
            });

            if (Object.keys(slots).length === 0) return;

            try {
                await fetch(`${API_BASE}/games/${currentGame.id}/availability`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player_id: currentPlayer.id,
                        day: currentDay,
                        slots: slots
                    })
                });
                await loadHeatmap();
            } catch (e) {
                console.error('Error saving availability:', e);
            }
        }

        function switchDay(day) {
            currentDay = day;
            document.getElementById('sat-tab').className = day === 'saturday'
                ? 'flex-1 py-2 rounded-t-lg bg-white dark:bg-card-dark border-b-2 border-primary font-bold text-primary'
                : 'flex-1 py-2 rounded-t-lg bg-slate-100 dark:bg-slate-800 text-slate-400 font-medium';
            document.getElementById('sun-tab').className = day === 'sunday'
                ? 'flex-1 py-2 rounded-t-lg bg-white dark:bg-card-dark border-b-2 border-primary font-bold text-primary'
                : 'flex-1 py-2 rounded-t-lg bg-slate-100 dark:bg-slate-800 text-slate-400 font-medium';

            renderTimeSlots();
            loadHeatmap();
        }

        function setupEventListeners() {
            document.getElementById('sat-tab').addEventListener('click', () => switchDay('saturday'));
            document.getElementById('sun-tab').addEventListener('click', () => switchDay('sunday'));
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>

</body>

</html>