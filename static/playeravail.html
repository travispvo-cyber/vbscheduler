<!DOCTYPE html>

<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Mark Availability - Volleyball</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&amp;family=Noto+Sans:wght@400;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2b8cee",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "success-green": "#22c55e",
                        "error-red": "#ef4444"
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Lexend', sans-serif;
        }

        .ios-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
<script>
        const API_BASE = '/api';
        let currentGame = null;
        let currentPlayer = null;
        let availability = { saturday: null, sunday: null };

        function showError(message) {
            // Remove existing error toasts
            document.querySelectorAll('.error-toast').forEach(el => el.remove());

            const toast = document.createElement('div');
            toast.className = 'error-toast fixed bottom-20 left-1/2 -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 4000);
        }

        async function apiCall(url, options = {}) {
            try {
                const res = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.message || 'Request failed');
                }

                return data;
            } catch (err) {
                showError(err.message);
                throw err;
            }
        }

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');

            if (!gameId) {
                alert('No game specified. Please use a valid invite link.');
                return;
            }

            await loadGame(gameId);
            checkExistingPlayer();
            setupEventListeners();
        }

        async function loadGame(gameId) {
            try {
                const res = await fetch(`${API_BASE}/games/${gameId}`);
                if (!res.ok) throw new Error('Game not found');
                currentGame = await res.json();
                displayGame();
                await loadGroupAvailability();
            } catch (e) {
                console.error('Error loading game:', e);
                alert('Game not found. Please check your invite link.');
            }
        }

        function displayGame() {
            if (!currentGame) return;
            const gameDate = new Date(currentGame.game_date);
            const options = { month: 'short', day: 'numeric' };
            const dateStr = gameDate.toLocaleDateString('en-US', options);

            // Calculate weekend dates
            const satDate = new Date(currentGame.game_date);
            const sunDate = new Date(currentGame.game_date);
            if (satDate.getDay() === 0) { // Sunday
                satDate.setDate(satDate.getDate() - 1);
            } else {
                sunDate.setDate(sunDate.getDate() + 1);
            }

            document.getElementById('game-title').textContent = `Weekend ${satDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}-${sunDate.getDate()}`;
            document.getElementById('game-venue').textContent = `${currentGame.venue}`;
        }

        function checkExistingPlayer() {
            const savedPlayerId = localStorage.getItem(`player_${currentGame?.id}`);
            const savedPlayerName = localStorage.getItem(`playerName_${currentGame?.id}`);
            if (savedPlayerId && savedPlayerName) {
                currentPlayer = { id: parseInt(savedPlayerId), name: savedPlayerName };
            }
        }

        async function loadGroupAvailability() {
            if (!currentGame) return;
            try {
                const res = await fetch(`${API_BASE}/games/${currentGame.id}/availability`);
                const allAvail = await res.json();

                // Count by day
                const satCount = new Set(allAvail.filter(a => a.day === 'saturday' && a.status === 'available').map(a => a.player_id)).size;
                const sunCount = new Set(allAvail.filter(a => a.day === 'sunday' && a.status === 'available').map(a => a.player_id)).size;

                document.getElementById('sat-count').textContent = `${satCount} / 12 Confirmed`;
                document.getElementById('sun-count').textContent = `${sunCount} / 12 Confirmed`;

                // Get player names for display
                const satPlayers = [...new Set(allAvail.filter(a => a.day === 'saturday' && a.status === 'available').map(a => a.player_name))];
                const sunPlayers = [...new Set(allAvail.filter(a => a.day === 'sunday' && a.status === 'available').map(a => a.player_name))];

                updatePlayerList('sat-players', satPlayers);
                updatePlayerList('sun-players', sunPlayers);
            } catch (e) {
                console.error('Error loading availability:', e);
            }
        }

        function updatePlayerList(elementId, players) {
            const el = document.getElementById(elementId);
            if (players.length === 0) {
                el.textContent = 'No one has confirmed yet.';
            } else if (players.length <= 3) {
                el.textContent = `${players.join(', ')} ${players.length === 1 ? 'is' : 'are'} in.`;
            } else {
                el.textContent = `${players.slice(0, 3).join(', ')} and ${players.length - 3} others are in.`;
            }
        }

        async function registerPlayer(name) {
            try {
                const res = await fetch(`${API_BASE}/games/${currentGame.id}/players`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                currentPlayer = await res.json();
                localStorage.setItem(`player_${currentGame.id}`, currentPlayer.id);
                localStorage.setItem(`playerName_${currentGame.id}`, currentPlayer.name);
                return true;
            } catch (e) {
                console.error('Error registering player:', e);
                return false;
            }
        }

        function showNamePrompt(day, status) {
            if (currentPlayer) {
                setAvailability(day, status);
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-4 text-center">What's your name?</h3>
                    <input id="player-name-input" type="text" placeholder="Enter your name"
                        class="w-full border border-gray-200 dark:border-gray-700 rounded-xl p-3 mb-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-white" />
                    <button id="confirm-name-btn"
                        class="w-full bg-primary text-white py-3 rounded-xl font-bold">
                        Confirm
                    </button>
                </div>
            `;
            document.body.appendChild(modal);

            const input = document.getElementById('player-name-input');
            const btn = document.getElementById('confirm-name-btn');

            btn.addEventListener('click', async () => {
                const name = input.value.trim();
                if (!name) {
                    alert('Please enter your name');
                    return;
                }
                if (await registerPlayer(name)) {
                    modal.remove();
                    setAvailability(day, status);
                }
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            input.focus();
        }

        function setAvailability(day, status) {
            availability[day] = status;
            updateButtonStyles(day, status);
        }

        function updateButtonStyles(day, status) {
            const inBtn = document.getElementById(`${day}-in-btn`);
            const outBtn = document.getElementById(`${day}-out-btn`);

            // Reset both buttons
            inBtn.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold';
            outBtn.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold';

            if (status === 'available') {
                inBtn.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-success-green/20 bg-success-green/5 text-success-green font-bold';
            } else if (status === 'unavailable') {
                outBtn.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-error-red/20 bg-error-red/5 text-error-red font-bold';
            }
        }

        async function saveAvailability() {
            if (!currentPlayer) {
                alert('Please select your availability first');
                return;
            }

            const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];

            try {
                for (const day of ['saturday', 'sunday']) {
                    if (availability[day]) {
                        const slots = {};
                        timeSlots.forEach(slot => {
                            slots[slot] = availability[day];
                        });

                        await fetch(`${API_BASE}/games/${currentGame.id}/availability`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                player_id: currentPlayer.id,
                                day: day,
                                slots: slots
                            })
                        });
                    }
                }

                alert('Availability saved!');
                await loadGroupAvailability();
            } catch (e) {
                console.error('Error saving availability:', e);
                alert('Failed to save availability');
            }
        }

        function setupEventListeners() {
            document.getElementById('saturday-in-btn').addEventListener('click', () => showNamePrompt('saturday', 'available'));
            document.getElementById('saturday-out-btn').addEventListener('click', () => showNamePrompt('saturday', 'unavailable'));
            document.getElementById('sunday-in-btn').addEventListener('click', () => showNamePrompt('sunday', 'available'));
            document.getElementById('sunday-out-btn').addEventListener('click', () => showNamePrompt('sunday', 'unavailable'));
            document.getElementById('save-btn').addEventListener('click', saveAvailability);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen">
    <div
        class="relative flex h-auto min-h-screen w-full max-w-md mx-auto flex-col bg-white dark:bg-background-dark overflow-x-hidden border-x border-gray-100 dark:border-gray-800">
        <!-- TopAppBar -->
        <div class="flex items-center bg-white dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-50">
            <div class="text-[#111418] dark:text-white flex size-12 shrink-0 items-center cursor-pointer">
                <span class="material-symbols-outlined">chevron_left</span>
            </div>
            <h2
                class="text-[#111418] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">
                Availability</h2>
        </div>
        <!-- HeadlineText -->
        <div class="px-4">
            <h2 id="game-title"
                class="text-[#111418] dark:text-white tracking-light text-[28px] font-bold leading-tight text-center pb-1 pt-5">
                Loading...</h2>
            <p id="game-venue" class="text-center text-[#617589] dark:text-gray-400 text-sm mb-6">Loading venue...</p>
        </div>
        <!-- Availability Section: Saturday -->
        <div class="mb-6">
            <div class="flex items-center justify-between px-4 pb-2 pt-4">
                <h3 class="text-[#111418] dark:text-white text-xl font-bold leading-tight tracking-[-0.015em]">Saturday
                </h3>
                <span id="sat-count" class="text-sm font-medium text-primary bg-primary/10 px-2 py-1 rounded-full">0 / 12
                    Confirmed</span>
            </div>
            <div class="p-4 @container">
                <div
                    class="flex flex-col gap-4 rounded-xl border border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-gray-900 p-5 ios-shadow">
                    <div class="flex flex-col gap-1">
                        <p class="text-[#111418] dark:text-white text-base font-bold leading-tight">Will you be playing?
                        </p>
                        <div class="flex gap-2 mt-4">
                            <button id="saturday-in-btn"
                                class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold">
                                <span class="material-symbols-outlined text-[20px]">check_circle</span>
                                I'm In
                            </button>
                            <button id="saturday-out-btn"
                                class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold">
                                <span class="material-symbols-outlined text-[20px]">cancel</span>
                                I'm Out
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <p id="sat-players" class="text-[#617589] dark:text-gray-400 text-sm font-normal leading-normal">No one has confirmed yet.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Availability Section: Sunday -->
        <div class="mb-24">
            <div class="flex items-center justify-between px-4 pb-2 pt-4">
                <h3 class="text-[#111418] dark:text-white text-xl font-bold leading-tight tracking-[-0.015em]">Sunday
                </h3>
                <span id="sun-count"
                    class="text-sm font-medium text-gray-500 bg-gray-100 dark:bg-gray-800 dark:text-gray-400 px-2 py-1 rounded-full">0
                    / 12 Confirmed</span>
            </div>
            <div class="p-4 @container">
                <div
                    class="flex flex-col gap-4 rounded-xl border border-[#dbe0e6] dark:border-gray-700 bg-white dark:bg-gray-900 p-5 ios-shadow">
                    <div class="flex flex-col gap-1">
                        <p class="text-[#111418] dark:text-white text-base font-bold leading-tight">Will you be playing?
                        </p>
                        <div class="flex gap-2 mt-4">
                            <button id="sunday-in-btn"
                                class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold">
                                <span class="material-symbols-outlined text-[20px]">check_circle</span>
                                I'm In
                            </button>
                            <button id="sunday-out-btn"
                                class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold">
                                <span class="material-symbols-outlined text-[20px]">cancel</span>
                                I'm Out
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <p id="sun-players" class="text-[#617589] dark:text-gray-400 text-sm font-normal leading-normal">No one has confirmed yet.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Sticky Bottom CTA -->
        <div
            class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md border-t border-gray-100 dark:border-gray-800 max-w-md mx-auto">
            <button id="save-btn"
                class="w-full bg-primary text-white font-bold py-4 rounded-xl text-lg shadow-lg active:scale-[0.98] transition-transform">
                Save My Availability
            </button>
        </div>
    </div>
</body>

</html>