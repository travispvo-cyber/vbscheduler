<!DOCTYPE html>

<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>VB Scheduler - Availability</title>
    <link rel="icon" type="image/png" href="/static/images/favicon.png">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#007AFF",
                        "background-light": "#ffffff",
                        "background-dark": "#000000",
                        "success-green": "#34C759",
                        "error-red": "#FF3B30",
                        "label": "#1d1d1f",
                        "secondary-label": "#86868b"
                    },
                    fontFamily: {
                        "display": ["-apple-system", "BlinkMacSystemFont", "SF Pro Display", "SF Pro Text", "Helvetica Neue", "Helvetica", "Arial", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .ios-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
    </style>
    <style>
        body {
            min-height: max(884px, 100dvh);
        }
        @keyframes toast-fade-in {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
    </style>
<script>
        const API_BASE = '/api';
        let currentGame = null;
        let currentPlayer = null;
        let availability = { saturday: null, sunday: null };
        let playerRoster = [];
        let registeredPlayers = [];
        let timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00'];
        let currentDay = 'saturday';
        let myAvailability = {};

        // Auto-save variables
        let saveTimeout = null;
        let isSaving = false;
        const SAVE_DEBOUNCE_MS = 800;

        // Drag-to-paint variables
        let isPainting = false;
        let paintState = null; // 'available', 'unavailable', or null (clear)
        let pendingChanges = false;

        // Availability presets
        const PRESETS = {
            anytime: { slots: 'all', label: 'Anytime', icon: 'select_all' },
            morning: { slots: ['09:00', '10:00', '11:00'], label: 'Morning', icon: 'wb_sunny' },
            afternoon: { slots: ['12:00', '13:00', '14:00', '15:00'], label: 'Afternoon', icon: 'light_mode' },
            evening: { slots: ['16:00', '17:00', '18:00', '19:00', '20:00', '21:00'], label: 'Evening', icon: 'nights_stay' },
            clear: { slots: 'none', label: 'Clear', icon: 'delete' }
        };

        function showError(message) {
            showToast(message, 'error');
        }

        function showSuccess(message) {
            showToast(message, 'success');
        }

        function showToast(message, type = 'success') {
            // Remove existing toasts
            document.querySelectorAll('.toast-notification').forEach(el => el.remove());

            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-600' : 'bg-gray-800';
            const icon = type === 'error' ? 'error' : 'check_circle';
            const iconColor = type === 'error' ? 'text-red-300' : 'text-green-400';

            toast.className = `toast-notification fixed bottom-24 left-1/2 -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2`;
            toast.style.animation = 'toast-fade-in 0.2s ease-out';
            toast.innerHTML = `
                <span class="material-symbols-outlined ${iconColor} text-sm">${icon}</span>
                <span class="text-sm font-medium">${message}</span>
            `;
            document.body.appendChild(toast);

            // Fade out animation
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(10px)';
                toast.style.transition = 'all 0.3s ease';
            }, type === 'error' ? 3500 : 1700);

            setTimeout(() => toast.remove(), type === 'error' ? 4000 : 2000);
        }

        async function apiCall(url, options = {}) {
            try {
                const res = await fetch(url, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', ...options.headers }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || 'Request failed');
                return data;
            } catch (err) {
                showError(err.message);
                throw err;
            }
        }

        async function loadConfig() {
            try {
                const config = await apiCall(`${API_BASE}/config`);
                playerRoster = config.player_roster || [];
                timeSlots = config.time_slots || timeSlots;
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }

        async function loadRegisteredPlayers() {
            if (!currentGame) return;
            try {
                const players = await apiCall(`${API_BASE}/games/${currentGame.id}/players`);
                registeredPlayers = players.map(p => p.name);
            } catch (e) {
                console.error('Failed to load players:', e);
            }
        }

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('game');

            if (!gameId) {
                alert('No game specified. Please use a valid invite link.');
                return;
            }

            await loadConfig();
            await loadGame(gameId);
            await loadRegisteredPlayers();
            checkExistingPlayer();
            setupEventListeners();

            // If player is already registered, show time slots UI and hide the "already signed up" link
            if (currentPlayer) {
                document.getElementById('already-signed-up')?.classList.add('hidden');
                showTimeSlotsUI();
            }
        }

        async function loadGame(gameId) {
            try {
                const data = await apiCall(`${API_BASE}/games/${gameId}`);
                currentGame = data;
                displayGame();
                await loadGroupAvailability();
            } catch (e) {
                console.error('Error loading game:', e);
                document.getElementById('game-title').textContent = 'Game Not Found';
                document.getElementById('game-venue').textContent = 'Please check your invite link';
            }
        }

        function displayGame() {
            if (!currentGame) return;
            const gameDate = new Date(currentGame.game_date);

            const satDate = new Date(currentGame.game_date);
            const sunDate = new Date(currentGame.game_date);
            if (satDate.getDay() === 0) {
                satDate.setDate(satDate.getDate() - 1);
            } else {
                sunDate.setDate(sunDate.getDate() + 1);
            }

            // Get selected days from game
            const selectedDays = currentGame.selected_days || ['saturday', 'sunday'];
            const hasSaturday = selectedDays.includes('saturday');
            const hasSunday = selectedDays.includes('sunday');

            // Show actual game title
            document.getElementById('game-title').textContent = currentGame.title || 'Volleyball Game';

            // Show venue with date
            let dateStr = '';
            if (hasSaturday && hasSunday) {
                dateStr = `${satDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}-${sunDate.getDate()}`;
            } else if (hasSaturday) {
                dateStr = satDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            } else {
                dateStr = sunDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }
            document.getElementById('game-venue').textContent = `${currentGame.venue} Â· ${dateStr}`;

            // Show/hide day sections based on host's selection
            const satSection = document.getElementById('saturday-section');
            const sunSection = document.getElementById('sunday-section');
            if (satSection) satSection.classList.toggle('hidden', !hasSaturday);
            if (sunSection) sunSection.classList.toggle('hidden', !hasSunday);

            // Update time slots tabs visibility
            const satTab = document.getElementById('sat-tab');
            const sunTab = document.getElementById('sun-tab');
            if (satTab) satTab.classList.toggle('hidden', !hasSaturday);
            if (sunTab) sunTab.classList.toggle('hidden', !hasSunday);

            // Set default current day to first available
            if (selectedDays.length > 0) {
                currentDay = selectedDays[0];
            }

            // Update tab navigation
            updateTabNav();
        }

        function checkExistingPlayer() {
            const savedPlayerId = localStorage.getItem(`player_${currentGame?.id}`);
            const savedPlayerName = localStorage.getItem(`playerName_${currentGame?.id}`);
            if (savedPlayerId && savedPlayerName) {
                currentPlayer = { id: parseInt(savedPlayerId), name: savedPlayerName };
                // Load existing availability for returning player
                loadMyAvailability();
            }
        }

        async function loadMyAvailability() {
            if (!currentGame || !currentPlayer) return;
            try {
                const allAvail = await apiCall(`${API_BASE}/games/${currentGame.id}/availability`);
                // Filter to just this player's availability
                const myAvail = allAvail.filter(a => a.player_id === currentPlayer.id);

                // Populate myAvailability object
                myAvail.forEach(a => {
                    const key = `${a.day}_${a.time_slot}`;
                    myAvailability[key] = a.status;
                });

                // Also set the day-level availability buttons
                const selectedDays = currentGame.selected_days || ['saturday', 'sunday'];
                selectedDays.forEach(day => {
                    const dayAvail = myAvail.filter(a => a.day === day);
                    if (dayAvail.some(a => a.status === 'available')) {
                        availability[day] = 'available';
                        updateButtonStyles(day, 'available');
                    } else if (dayAvail.some(a => a.status === 'unavailable')) {
                        availability[day] = 'unavailable';
                        updateButtonStyles(day, 'unavailable');
                    }
                });
            } catch (e) {
                console.error('Error loading my availability:', e);
            }
        }

        async function loadGroupAvailability() {
            if (!currentGame) return;
            try {
                const allAvail = await apiCall(`${API_BASE}/games/${currentGame.id}/availability`);
                const minPlayers = currentGame.min_players || 4;

                const satCount = new Set(allAvail.filter(a => a.day === 'saturday' && a.status === 'available').map(a => a.player_id)).size;
                const sunCount = new Set(allAvail.filter(a => a.day === 'sunday' && a.status === 'available').map(a => a.player_id)).size;

                const satCountEl = document.getElementById('sat-count');
                const sunCountEl = document.getElementById('sun-count');
                if (satCountEl) satCountEl.textContent = `${satCount} / ${minPlayers} Confirmed`;
                if (sunCountEl) sunCountEl.textContent = `${sunCount} / ${minPlayers} Confirmed`;

                const satPlayers = [...new Set(allAvail.filter(a => a.day === 'saturday' && a.status === 'available').map(a => a.player_name))];
                const sunPlayers = [...new Set(allAvail.filter(a => a.day === 'sunday' && a.status === 'available').map(a => a.player_name))];

                updatePlayerList('sat-players', satPlayers);
                updatePlayerList('sun-players', sunPlayers);
            } catch (e) {
                console.error('Error loading availability:', e);
            }
        }

        function updatePlayerList(elementId, players) {
            const el = document.getElementById(elementId);
            if (players.length === 0) {
                el.textContent = 'No one has confirmed yet.';
            } else if (players.length <= 3) {
                el.textContent = `${players.join(', ')} ${players.length === 1 ? 'is' : 'are'} in.`;
            } else {
                el.textContent = `${players.slice(0, 3).join(', ')} and ${players.length - 3} others are in.`;
            }
        }

        async function registerPlayer(name) {
            if (!currentGame) {
                showError('Game not loaded. Please refresh the page.');
                return false;
            }
            try {
                const data = await apiCall(`${API_BASE}/games/${currentGame.id}/players`, {
                    method: 'POST',
                    body: JSON.stringify({ name })
                });
                currentPlayer = data;
                localStorage.setItem(`player_${currentGame.id}`, currentPlayer.id);
                localStorage.setItem(`playerName_${currentGame.id}`, currentPlayer.name);
                registeredPlayers.push(name);
                return true;
            } catch (e) {
                console.error('Error registering player:', e);
                return false;
            }
        }

        function getAvailableNames() {
            return playerRoster.filter(name => !registeredPlayers.includes(name));
        }

        async function showReturningPlayerPrompt() {
            if (!currentGame) {
                showError('Game not loaded. Please refresh the page.');
                return;
            }

            // Get the list of already-registered players
            await loadRegisteredPlayers();
            const players = await apiCall(`${API_BASE}/games/${currentGame.id}/players`);

            if (players.length === 0) {
                showError('No players have signed up yet.');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-2 text-center">Welcome back!</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 text-center">Select your name to update your availability</p>
                    <select id="returning-player-select"
                        class="w-full border border-gray-200 dark:border-gray-700 rounded-xl p-3 mb-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                        <option value="">Select your name...</option>
                        ${players.map(p => `<option value="${p.id}" data-name="${p.name}">${p.name}</option>`).join('')}
                    </select>
                    <button id="confirm-returning-btn"
                        class="w-full bg-primary text-white py-3 rounded-xl font-bold">
                        Continue
                    </button>
                    <button id="cancel-returning-btn"
                        class="w-full text-gray-500 py-2 mt-2 text-sm">
                        Cancel
                    </button>
                </div>
            `;
            document.body.appendChild(modal);

            const select = document.getElementById('returning-player-select');
            const confirmBtn = document.getElementById('confirm-returning-btn');
            const cancelBtn = document.getElementById('cancel-returning-btn');

            confirmBtn.addEventListener('click', async () => {
                const playerId = select.value;
                const playerName = select.options[select.selectedIndex]?.dataset.name;
                if (!playerId || !playerName) {
                    showError('Please select your name');
                    return;
                }

                // Set current player and save to localStorage
                currentPlayer = { id: parseInt(playerId), name: playerName };
                localStorage.setItem(`player_${currentGame.id}`, playerId);
                localStorage.setItem(`playerName_${currentGame.id}`, playerName);

                // Load their existing availability
                await loadMyAvailability();

                modal.remove();
                showSuccess(`Welcome back, ${playerName}!`);

                // Hide the "already signed up" link and show the time slots
                document.getElementById('already-signed-up')?.classList.add('hidden');
                showTimeSlotsUI();
            });

            cancelBtn.addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        async function showNamePrompt(day, status) {
            if (!currentGame) {
                showError('Game not loaded. Please refresh the page.');
                return;
            }
            if (currentPlayer) {
                setAvailability(day, status);
                if (status === 'available') showTimeSlotsUI();
                return;
            }

            // Refresh registered players before showing dropdown
            await loadRegisteredPlayers();
            const availableNames = getAvailableNames();

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-900 rounded-2xl p-6 max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-4 text-center">Who are you?</h3>
                    ${availableNames.length > 0 ? `
                        <select id="player-name-select"
                            class="w-full border border-gray-200 dark:border-gray-700 rounded-xl p-3 mb-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-white">
                            <option value="">Select your name...</option>
                            ${availableNames.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                    ` : `
                        <p class="text-center text-gray-500 mb-4">All players have already registered.</p>
                    `}
                    <button id="confirm-name-btn"
                        class="w-full bg-primary text-white py-3 rounded-xl font-bold ${availableNames.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${availableNames.length === 0 ? 'disabled' : ''}>
                        Confirm
                    </button>
                </div>
            `;
            document.body.appendChild(modal);

            const select = document.getElementById('player-name-select');
            const btn = document.getElementById('confirm-name-btn');

            if (select) {
                btn.addEventListener('click', async () => {
                    const name = select.value;
                    if (!name) {
                        showError('Please select your name');
                        return;
                    }
                    if (await registerPlayer(name)) {
                        modal.remove();
                        document.getElementById('already-signed-up')?.classList.add('hidden');
                        setAvailability(day, status);
                        if (status === 'available') showTimeSlotsUI();
                    }
                });
            }

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function setAvailability(day, status) {
            availability[day] = status;
            updateButtonStyles(day, status);
        }

        function updateButtonStyles(day, status) {
            const inBtn = document.getElementById(`${day}-in-btn`);
            const outBtn = document.getElementById(`${day}-out-btn`);

            inBtn.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold';
            outBtn.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold';

            if (status === 'available') {
                inBtn.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-success-green/20 bg-success-green/5 text-success-green font-bold';
            } else if (status === 'unavailable') {
                outBtn.className = 'flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-error-red/20 bg-error-red/5 text-error-red font-bold';
            }
        }

        // ============ TIME SLOTS UI ============

        function showTimeSlotsUI() {
            const container = document.getElementById('time-slots-section');
            if (!container) return;
            container.classList.remove('hidden');
            renderTimeSlots();
            initDragToPaint();
            loadHeatmap();
        }

        function renderTimeSlots() {
            const container = document.getElementById('time-slots-container');
            if (!container) return;
            container.innerHTML = '';

            timeSlots.forEach((slot, idx) => {
                const hour = parseInt(slot.split(':')[0]);
                const displayTime = hour > 12 ? `${hour - 12} PM` : (hour === 12 ? '12 PM' : `${hour} AM`);

                // Check if we have pre-loaded availability for this slot
                const key = `${currentDay}_${slot}`;
                const status = myAvailability[key];
                let btnClass = 'slot-btn w-full h-10 rounded-md bg-gray-200 dark:bg-gray-700 transition-colors active:scale-95 flex items-center justify-center';
                let iconClass = 'material-symbols-outlined text-gray-400 text-sm';
                let iconText = 'help';

                if (status === 'available') {
                    btnClass = 'slot-btn w-full h-10 rounded-md bg-success-green transition-colors active:scale-95 flex items-center justify-center';
                    iconClass = 'material-symbols-outlined text-white text-sm';
                    iconText = 'check';
                } else if (status === 'unavailable') {
                    btnClass = 'slot-btn w-full h-10 rounded-md bg-error-red transition-colors active:scale-95 flex items-center justify-center';
                    iconClass = 'material-symbols-outlined text-white text-sm';
                    iconText = 'close';
                }

                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 items-center' + (idx < timeSlots.length - 1 ? ' border-b border-gray-100 dark:border-gray-800' : '');
                row.innerHTML = `
                    <div class="col-span-2 text-[10px] font-bold text-right pr-2 text-gray-400">${displayTime}</div>
                    <div class="col-span-5 p-1">
                        <button data-slot="${slot}" class="${btnClass}">
                            <span class="${iconClass}">${iconText}</span>
                        </button>
                    </div>
                    <div class="col-span-5 p-1">
                        <div id="heatmap-${slot}" class="w-full h-10 rounded-md bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                            <span class="text-[10px] font-bold text-gray-400">0/0</span>
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            // Note: Click handlers removed - using drag-to-paint instead via initDragToPaint()
        }

        function toggleSlot(btn) {
            const slot = btn.dataset.slot;
            const key = `${currentDay}_${slot}`;
            const icon = btn.querySelector('.material-symbols-outlined');

            if (myAvailability[key] === 'available') {
                myAvailability[key] = 'unavailable';
                btn.className = 'slot-btn w-full h-10 rounded-md bg-error-red transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'close';
                icon.className = 'material-symbols-outlined text-white text-sm';
            } else if (myAvailability[key] === 'unavailable') {
                delete myAvailability[key];
                btn.className = 'slot-btn w-full h-10 rounded-md bg-gray-200 dark:bg-gray-700 transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'help';
                icon.className = 'material-symbols-outlined text-gray-400 text-sm';
            } else {
                myAvailability[key] = 'available';
                btn.className = 'slot-btn w-full h-10 rounded-md bg-success-green transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'check';
                icon.className = 'material-symbols-outlined text-white text-sm';
            }

            // Auto-save after each toggle
            queueSave();
        }

        // ============ DRAG-TO-PAINT ============

        function initDragToPaint() {
            const container = document.getElementById('time-slots-container');
            if (!container) return;

            // Prevent text selection and scrolling while dragging
            container.style.userSelect = 'none';
            container.style.webkitUserSelect = 'none';
            container.style.touchAction = 'none';

            container.addEventListener('pointerdown', handlePointerDown);
            container.addEventListener('pointermove', handlePointerMove);
            container.addEventListener('pointerup', handlePointerUp);
            container.addEventListener('pointercancel', handlePointerUp);
            container.addEventListener('pointerleave', handlePointerUp);
        }

        function handlePointerDown(e) {
            const btn = e.target.closest('.slot-btn');
            if (!btn) return;

            e.preventDefault();
            isPainting = true;

            // Determine paint state based on current state of first cell
            const slot = btn.dataset.slot;
            const key = `${currentDay}_${slot}`;
            const currentStatus = myAvailability[key];

            // Cycle: unset -> available -> unavailable -> unset
            if (!currentStatus) {
                paintState = 'available';
            } else if (currentStatus === 'available') {
                paintState = 'unavailable';
            } else {
                paintState = null; // clear
            }

            applyPaintToSlot(btn);
            btn.setPointerCapture(e.pointerId);
        }

        function handlePointerMove(e) {
            if (!isPainting) return;

            const el = document.elementFromPoint(e.clientX, e.clientY);
            const btn = el?.closest('.slot-btn');
            if (btn) {
                applyPaintToSlot(btn);
            }
        }

        function handlePointerUp(e) {
            if (isPainting) {
                isPainting = false;
                paintState = null;
                if (pendingChanges) {
                    queueSave();
                    pendingChanges = false;
                }
            }
        }

        function applyPaintToSlot(btn) {
            const slot = btn.dataset.slot;
            const key = `${currentDay}_${slot}`;
            const icon = btn.querySelector('.material-symbols-outlined');
            const oldStatus = myAvailability[key];

            if (paintState === 'available') {
                myAvailability[key] = 'available';
                btn.className = 'slot-btn w-full h-10 rounded-md bg-success-green transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'check';
                icon.className = 'material-symbols-outlined text-white text-sm';
            } else if (paintState === 'unavailable') {
                myAvailability[key] = 'unavailable';
                btn.className = 'slot-btn w-full h-10 rounded-md bg-error-red transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'close';
                icon.className = 'material-symbols-outlined text-white text-sm';
            } else {
                delete myAvailability[key];
                btn.className = 'slot-btn w-full h-10 rounded-md bg-gray-200 dark:bg-gray-700 transition-colors active:scale-95 flex items-center justify-center';
                icon.textContent = 'help';
                icon.className = 'material-symbols-outlined text-gray-400 text-sm';
            }

            if (myAvailability[key] !== oldStatus) {
                pendingChanges = true;
            }
        }

        // ============ PRESETS ============

        function applyPreset(presetKey) {
            const preset = PRESETS[presetKey];
            if (!preset) return;

            const allSlots = document.querySelectorAll('.slot-btn');

            allSlots.forEach(btn => {
                const slot = btn.dataset.slot;
                const key = `${currentDay}_${slot}`;
                const icon = btn.querySelector('.material-symbols-outlined');

                let shouldBeAvailable = false;
                if (preset.slots === 'all') {
                    shouldBeAvailable = true;
                } else if (preset.slots === 'none') {
                    shouldBeAvailable = false;
                } else {
                    shouldBeAvailable = preset.slots.includes(slot);
                }

                if (shouldBeAvailable) {
                    myAvailability[key] = 'available';
                    btn.className = 'slot-btn w-full h-10 rounded-md bg-success-green transition-colors active:scale-95 flex items-center justify-center';
                    icon.textContent = 'check';
                    icon.className = 'material-symbols-outlined text-white text-sm';
                } else if (preset.slots === 'none') {
                    delete myAvailability[key];
                    btn.className = 'slot-btn w-full h-10 rounded-md bg-gray-200 dark:bg-gray-700 transition-colors active:scale-95 flex items-center justify-center';
                    icon.textContent = 'help';
                    icon.className = 'material-symbols-outlined text-gray-400 text-sm';
                } else {
                    myAvailability[key] = 'unavailable';
                    btn.className = 'slot-btn w-full h-10 rounded-md bg-error-red transition-colors active:scale-95 flex items-center justify-center';
                    icon.textContent = 'close';
                    icon.className = 'material-symbols-outlined text-white text-sm';
                }
            });

            queueSave();
            showToast(`Applied: ${preset.label}`);
        }

        function switchDay(day) {
            currentDay = day;
            document.getElementById('sat-tab').className = day === 'saturday'
                ? 'flex-1 py-2 rounded-lg bg-primary text-white font-bold'
                : 'flex-1 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-400 font-medium';
            document.getElementById('sun-tab').className = day === 'sunday'
                ? 'flex-1 py-2 rounded-lg bg-primary text-white font-bold'
                : 'flex-1 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-400 font-medium';
            renderTimeSlots();
            loadHeatmap();
        }

        async function loadHeatmap() {
            if (!currentGame) return;
            try {
                const heatmapData = await apiCall(`${API_BASE}/games/${currentGame.id}/heatmap`);
                const dayData = heatmapData.find(d => d.day === currentDay);
                if (!dayData) return;

                dayData.slots.forEach(slot => {
                    const el = document.getElementById(`heatmap-${slot.time_slot}`);
                    if (el) {
                        const ratio = slot.total_count > 0 ? slot.available_count / slot.total_count : 0;
                        let bgClass = 'bg-gray-100 dark:bg-gray-800';
                        let textClass = 'text-gray-400';

                        if (ratio >= 0.8) {
                            bgClass = 'bg-gray-500 dark:bg-gray-400';
                            textClass = 'text-white dark:text-gray-900';
                        } else if (ratio >= 0.6) {
                            bgClass = 'bg-gray-400 dark:bg-gray-500';
                            textClass = 'text-white';
                        } else if (ratio >= 0.4) {
                            bgClass = 'bg-gray-300 dark:bg-gray-600';
                            textClass = 'text-gray-600 dark:text-gray-300';
                        } else if (ratio > 0) {
                            bgClass = 'bg-gray-200 dark:bg-gray-700';
                            textClass = 'text-gray-500';
                        }

                        el.className = `w-full h-10 rounded-md ${bgClass} flex items-center justify-center`;
                        el.innerHTML = `<span class="text-[10px] font-bold ${textClass}">${slot.available_count}/${slot.total_count}</span>`;
                    }
                });
            } catch (e) {
                console.error('Error loading heatmap:', e);
            }
        }

        // Queue save with debounce
        function queueSave() {
            if (!currentPlayer) return;

            clearTimeout(saveTimeout);
            updateSaveIndicator('pending');

            saveTimeout = setTimeout(async () => {
                await autoSave();
            }, SAVE_DEBOUNCE_MS);
        }

        async function autoSave() {
            if (!currentPlayer) return;
            if (isSaving) return;

            isSaving = true;
            updateSaveIndicator('saving');

            try {
                const selectedDays = currentGame?.selected_days || ['saturday', 'sunday'];

                for (const day of selectedDays) {
                    const slots = {};
                    timeSlots.forEach(slot => {
                        const key = `${day}_${slot}`;
                        if (myAvailability[key]) {
                            slots[slot] = myAvailability[key];
                        }
                    });

                    if (Object.keys(slots).length > 0) {
                        await fetch(`${API_BASE}/games/${currentGame.id}/availability`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                player_id: currentPlayer.id,
                                day: day,
                                slots: slots
                            })
                        });
                    }
                }

                updateSaveIndicator('saved');
                showToast('Saved');
                await loadHeatmap();

            } catch (e) {
                console.error('Auto-save error:', e);
                updateSaveIndicator('error');
                showToast('Save failed', 'error');
            } finally {
                isSaving = false;
            }
        }

        function updateSaveIndicator(status) {
            const indicator = document.getElementById('save-indicator');
            if (!indicator) return;

            switch (status) {
                case 'pending':
                    indicator.innerHTML = '<span class="text-yellow-500 text-xs">Unsaved changes...</span>';
                    indicator.classList.remove('hidden');
                    break;
                case 'saving':
                    indicator.innerHTML = '<span class="text-primary text-xs flex items-center gap-1"><span class="material-symbols-outlined text-xs animate-spin">sync</span>Saving...</span>';
                    indicator.classList.remove('hidden');
                    break;
                case 'saved':
                    indicator.innerHTML = '<span class="text-success-green text-xs flex items-center gap-1"><span class="material-symbols-outlined text-xs">check_circle</span>Saved</span>';
                    setTimeout(() => {
                        indicator.innerHTML = '<span class="text-gray-400 text-xs flex items-center gap-1"><span class="material-symbols-outlined text-xs">check_circle</span>Auto-save on</span>';
                    }, 2000);
                    break;
                case 'error':
                    indicator.innerHTML = '<span class="text-error-red text-xs">Save failed</span>';
                    break;
            }
        }

        // Manual save (still available as backup)
        async function saveAvailability() {
            if (!currentPlayer) {
                showError('Please select your name first');
                return;
            }
            await autoSave();
        }

        function goBack() {
            // Navigate to landing page with game ID if available
            if (currentGame?.id) {
                window.location.href = `/landing.html?game=${currentGame.id}`;
            } else {
                window.location.href = '/';
            }
        }

        function updateTabNav() {
            if (currentGame) {
                document.getElementById('tab-home').href = `/landing.html?game=${currentGame.id}`;
                document.getElementById('tab-mytimes').href = `/playeravail.html?game=${currentGame.id}`;
            }
        }

        function setupEventListeners() {
            document.getElementById('saturday-in-btn').addEventListener('click', () => showNamePrompt('saturday', 'available'));
            document.getElementById('saturday-out-btn').addEventListener('click', () => showNamePrompt('saturday', 'unavailable'));
            document.getElementById('sunday-in-btn').addEventListener('click', () => showNamePrompt('sunday', 'available'));
            document.getElementById('sunday-out-btn').addEventListener('click', () => showNamePrompt('sunday', 'unavailable'));
            document.getElementById('done-btn')?.addEventListener('click', () => {
                // Navigate back to home
                if (currentGame?.id) {
                    window.location.href = `/landing.html?game=${currentGame.id}`;
                } else {
                    window.location.href = '/';
                }
            });
            document.getElementById('sat-tab')?.addEventListener('click', () => switchDay('saturday'));
            document.getElementById('sun-tab')?.addEventListener('click', () => switchDay('sunday'));
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen">
    <div
        class="relative flex h-auto min-h-screen w-full max-w-md mx-auto flex-col bg-white dark:bg-background-dark overflow-x-hidden border-x border-gray-100 dark:border-gray-800">
        <!-- Apple HIG Header -->
        <header class="bg-white/80 dark:bg-background-dark/80 backdrop-blur-lg sticky top-0 z-50 border-b border-gray-200/50 dark:border-gray-800/50">
            <div class="py-6 px-4">
                <h1 id="game-title" class="text-label dark:text-white text-xl font-semibold text-center tracking-tight">
                    Loading...</h1>
                <p id="game-venue" class="text-center text-secondary-label dark:text-gray-400 text-sm mt-1">Loading venue...</p>
            </div>
            <!-- Tab Navigation -->
            <nav id="tab-nav" class="border-t border-gray-100 dark:border-gray-800">
                <div class="flex">
                    <a id="tab-home" href="#"
                       class="flex-1 py-3 text-center text-sm font-medium text-secondary-label dark:text-gray-400 flex items-center justify-center gap-1.5 hover:text-primary transition-colors">
                        <span class="material-symbols-outlined text-[18px]">home</span>
                        Home
                    </a>
                    <a id="tab-mytimes" href="#"
                       class="flex-1 py-3 text-center text-sm font-medium text-primary border-b-2 border-primary flex items-center justify-center gap-1.5">
                        <span class="material-symbols-outlined text-[18px]">schedule</span>
                        My Times
                    </a>
                </div>
            </nav>
        </header>
        <!-- Availability Section: Saturday -->
        <div id="saturday-section" class="mb-6">
            <div class="flex items-center justify-between px-4 pb-2 pt-4">
                <h3 class="text-label dark:text-white text-xl font-bold leading-tight tracking-[-0.015em]">Saturday
                </h3>
                <span id="sat-count" class="text-sm font-medium text-primary bg-primary/10 px-2 py-1 rounded-full">0 / 12
                    Confirmed</span>
            </div>
            <div class="p-4 @container">
                <div
                    class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-5 ios-shadow">
                    <div class="flex flex-col gap-1">
                        <p class="text-label dark:text-white text-base font-bold leading-tight">Will you be playing?
                        </p>
                        <div class="flex gap-2 mt-4">
                            <button id="saturday-in-btn"
                                class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold">
                                <span class="material-symbols-outlined text-[20px]">check_circle</span>
                                I'm In
                            </button>
                            <button id="saturday-out-btn"
                                class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold">
                                <span class="material-symbols-outlined text-[20px]">cancel</span>
                                I'm Out
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <p id="sat-players" class="text-secondary-label dark:text-gray-400 text-sm font-normal leading-normal">No one has confirmed yet.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Availability Section: Sunday -->
        <div id="sunday-section" class="mb-6">
            <div class="flex items-center justify-between px-4 pb-2 pt-4">
                <h3 class="text-label dark:text-white text-xl font-bold leading-tight tracking-[-0.015em]">Sunday
                </h3>
                <span id="sun-count"
                    class="text-sm font-medium text-gray-500 bg-gray-100 dark:bg-gray-800 dark:text-gray-400 px-2 py-1 rounded-full">0
                    / 12 Confirmed</span>
            </div>
            <div class="p-4 @container">
                <div
                    class="flex flex-col gap-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 p-5 ios-shadow">
                    <div class="flex flex-col gap-1">
                        <p class="text-label dark:text-white text-base font-bold leading-tight">Will you be playing?
                        </p>
                        <div class="flex gap-2 mt-4">
                            <button id="sunday-in-btn"
                                class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold">
                                <span class="material-symbols-outlined text-[20px]">check_circle</span>
                                I'm In
                            </button>
                            <button id="sunday-out-btn"
                                class="flex-1 flex items-center justify-center gap-2 py-3 rounded-lg border-2 border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800 text-gray-400 font-bold">
                                <span class="material-symbols-outlined text-[20px]">cancel</span>
                                I'm Out
                            </button>
                        </div>
                    </div>
                    <div class="mt-2 border-t border-gray-100 dark:border-gray-800 pt-4">
                        <p id="sun-players" class="text-secondary-label dark:text-gray-400 text-sm font-normal leading-normal">No one has confirmed yet.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Slots Section (shown after player registers) -->
        <div id="time-slots-section" class="hidden mb-24">
            <div class="px-4 pb-4">
                <div class="bg-primary/5 dark:bg-primary/10 p-4 rounded-xl border border-primary/20">
                    <h3 class="text-sm font-semibold text-primary uppercase mb-3">Mark Your Time Availability</h3>
                    <div class="flex flex-wrap gap-4 items-center text-sm mb-3">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-success-green"></div>
                            <span class="text-secondary-label dark:text-gray-400">Available</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-error-red"></div>
                            <span class="text-secondary-label dark:text-gray-400">Unavailable</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-gray-300 dark:bg-gray-600"></div>
                            <span class="text-secondary-label dark:text-gray-400">Group</span>
                        </div>
                    </div>
                    <p class="text-xs text-secondary-label dark:text-gray-400 italic">Tap or drag to select your availability</p>
                </div>
            </div>

            <!-- Preset Buttons -->
            <div class="px-4 pb-4">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-2 font-medium">Quick Select:</p>
                <div class="flex flex-wrap gap-2">
                    <button onclick="applyPreset('anytime')"
                        class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-success-green/10 text-success-green text-xs font-semibold hover:bg-success-green/20 transition-colors">
                        <span class="material-symbols-outlined text-sm">select_all</span>
                        Anytime
                    </button>
                    <button onclick="applyPreset('morning')"
                        class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 text-xs font-semibold hover:bg-amber-200 dark:hover:bg-amber-900/50 transition-colors">
                        <span class="material-symbols-outlined text-sm">wb_sunny</span>
                        Morning
                    </button>
                    <button onclick="applyPreset('afternoon')"
                        class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 text-xs font-semibold hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors">
                        <span class="material-symbols-outlined text-sm">light_mode</span>
                        Afternoon
                    </button>
                    <button onclick="applyPreset('evening')"
                        class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 text-xs font-semibold hover:bg-indigo-200 dark:hover:bg-indigo-900/50 transition-colors">
                        <span class="material-symbols-outlined text-sm">nights_stay</span>
                        Evening
                    </button>
                    <button onclick="applyPreset('clear')"
                        class="flex items-center gap-1 px-3 py-1.5 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-500 text-xs font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <span class="material-symbols-outlined text-sm">delete</span>
                        Clear
                    </button>
                </div>
            </div>

            <!-- Day Tabs -->
            <div class="flex px-4 gap-2 mb-2">
                <button id="sat-tab" class="flex-1 py-2 rounded-lg bg-primary text-white font-bold">Saturday</button>
                <button id="sun-tab" class="flex-1 py-2 rounded-lg bg-gray-100 dark:bg-gray-800 text-gray-400 font-medium">Sunday</button>
            </div>

            <!-- Time Slots Grid -->
            <div class="px-4">
                <div class="bg-white dark:bg-gray-900 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden ios-shadow">
                    <div class="grid grid-cols-12 border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50">
                        <div class="col-span-2 p-2"></div>
                        <div class="col-span-5 p-2 text-center text-xs font-bold text-secondary-label dark:text-gray-400 uppercase">My Status</div>
                        <div class="col-span-5 p-2 text-center text-xs font-bold text-secondary-label dark:text-gray-400 uppercase">Group</div>
                    </div>
                    <div id="time-slots-container" class="divide-y divide-gray-100 dark:divide-gray-800">
                        <!-- Time slots rendered dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Sticky Bottom CTA -->
        <div
            class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md border-t border-gray-100 dark:border-gray-800 max-w-md mx-auto">
            <div class="flex items-center justify-between gap-4">
                <span id="save-indicator" class="text-gray-400 text-xs flex items-center gap-1">
                    <span class="material-symbols-outlined text-xs">check_circle</span>Auto-save on
                </span>
                <button id="done-btn"
                    class="bg-primary text-white font-bold py-3 px-8 rounded-xl shadow-lg active:scale-[0.98] transition-transform">
                    Done
                </button>
            </div>
        </div>
    </div>
</body>

</html>